<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>내체표 아웃풋</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Press+Start+2P&family=Source+Code+Pro:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <style>
    :root {
      --bg-dark: #1A1A2E;
      --bg-light: #16213E;
      --primary: #E94560;
      --secondary: #0F3460;
      --accent: #533483;
      --text-light: #F0F0F0;
      --text-dark: #A0A0A0;
      --correct: #39FF14; /* Neon Green */
      --incorrect: #FF5733; /* Bright Orange-Red */
      --retrying: #FFC300; /* Amber/Yellow for retry */
      --revealed: #00FFFF; /* Cyan */
      font-size: 10px; /* Base font size for rem units */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-light);
      line-height: 1.7;
      overflow-x: hidden;
      font-weight: 400;
    }
    
    #combo-counter {
        font-family: 'Press Start 2P', cursive;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: var(--bg-light);
      border-bottom: 4px solid var(--primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 2rem;
      z-index: 100;
      flex-wrap: wrap;
    }
    
    .hud-left, .hud-center, .hud-right {
        flex: 1;
        display: flex;
        align-items: center;
    }

    .hud-left {
        justify-content: flex-start;
    }

    .hud-center {
        justify-content: center;
        gap: 2rem;
    }

    .hud-right {
      justify-content: flex-end;
      gap: 1.5rem;
    }

    header h1 {
      font-family: 'Press Start 2P', cursive;
      font-size: 2.2rem;
      color: var(--primary);
      text-shadow: 3px 3px 0px var(--secondary);
    }

    .kitsch-box {
      background: var(--secondary);
      padding: 1rem 1.5rem;
      border: 3px solid var(--primary);
      box-shadow: 4px 4px 0px var(--bg-dark);
      border-radius: 8px;
    }

    #time {
      font-family: 'Source Code Pro', monospace;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-light);
    }

    #bar {
      width: 16rem;
      height: 1rem;
      background: var(--bg-dark);
      border: 2px solid var(--primary);
      overflow: hidden;
      margin-top: 0.5rem;
      border-radius: 4px;
    }

    #bar > div {
      height: 100%;
      width: 100%;
      background: var(--primary);
      transition: width 1s linear;
      border-radius: 2px;
    }

    .btn {
      cursor: pointer;
      font-weight: 700;
      color: var(--text-light);
      background: var(--accent);
      border: 3px solid var(--primary);
      padding: 1rem 1.5rem;
      box-shadow: 5px 5px 0px var(--secondary);
      transition: transform 0.1s, box-shadow 0.1s;
      font-size: 1.4rem;
      white-space: nowrap;
      border-radius: 8px;
    }
    .btn:hover {
      transform: translate(2px, 2px);
      box-shadow: 3px 3px 0px var(--secondary);
    }
    .btn:active {
      transform: translate(5px, 5px);
      box-shadow: 0px 0px 0px var(--secondary);
    }
      .btn.hidden {
        display: none;
    }
    .btn:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
        border-color: #555;
        box-shadow: none;
        transform: none;
    }

    #combo-counter {
        color: var(--incorrect);
        font-size: 2.2rem; /* Match H1 size */
        font-weight: 800;
        text-shadow: 2px 2px 0px var(--primary);
    }
    .combo-pop { animation: combo-pop-animation 0.3s ease-out; }
    @keyframes combo-pop-animation {
        0% { transform: scale(1); } 50% { transform: scale(1.4); } 100% { transform: scale(1); }
    }
    .hidden { display: none; }

    main {
      padding: 12rem 2rem 4rem;
      max-width: 1024px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2.5rem;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 1.2rem 0;
      background: var(--secondary);
      border: 3px solid var(--primary);
      cursor: pointer;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-dark);
      transition: all 0.2s;
      border-radius: 8px;
    }
    .tab.active {
      background: var(--primary);
      color: var(--text-light);
      transform: translateY(3px);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    section { display: none; }
    section.active { display: block; }

    h2 {
      text-align: center;
      color: var(--text-light);
      margin: 2rem 0 3rem 0;
      font-size: 2.4rem;
      font-weight: 900;
      background: var(--accent);
      padding: 1.5rem;
      border: 3px solid var(--primary);
      border-radius: 12px;
    }

    .grade-container {
      display: flex;
      gap: 2.5rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }
    .grade-container > div {
      flex: 1;
      min-width: 320px;
      background: var(--bg-light);
      border: 3px solid var(--primary);
      padding: 2rem;
      border-radius: 12px;
    }
    .grade-title {
      background: var(--primary);
      padding: 1rem;
      font-size: 1.8rem;
      font-weight: 900;
      text-align: center;
      color: var(--text-light);
      margin: -2rem -2rem 2rem -2rem;
      border-bottom: 3px solid var(--primary);
      border-radius: 8px 8px 0 0;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 1.5rem;
    }
    th, td {
      padding: 0;
      text-align: left;
      vertical-align: top;
      border-bottom: none;
      font-size: 1.6rem;
      font-weight: 700;
    }
    th {
      padding-right: 1.5rem;
      color: var(--text-dark);
      width: 1%; /* Prevent th from taking too much space */
      white-space: nowrap;
    }
    
    td {
      display: flex;
      flex-direction: column;
      gap: 1rem; /* Consistent spacing between inputs */
    }

    td input {
      width: 100%;
      padding: 1.2rem;
      font-size: 1.4rem;
      border: 2px solid var(--text-dark);
      background: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Noto Sans KR', sans-serif;
      caret-color: var(--primary);
      margin-bottom: 0; /* Removed margin as gap is used now */
      transition: all 0.2s ease;
      border-radius: 8px;
    }
    td input:focus {
      outline: none;
      border-color: var(--primary);
      background: var(--secondary);
      box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
    }
    td input.correct {
      border-color: var(--correct);
      color: var(--correct);
    }
    td input.incorrect {
      border-color: var(--incorrect);
      color: var(--incorrect);
    }
    td input.retrying {
        border-color: var(--retrying);
        color: var(--retrying);
    }
    td input.revealed {
      color: var(--revealed);
      border-color: var(--revealed);
      background: var(--bg-light);
    }
    
    .grade-container table tr:not(:last-child) > * {
        border-bottom: 3px dotted var(--secondary);
        padding-bottom: 1.5rem;
    }

    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 200; opacity: 0; transition: opacity 0.3s ease;
    }
    .modal-overlay.active { display: flex; opacity: 1; }
    .modal-content {
      background: var(--bg-light);
      padding: 3rem 4rem;
      text-align: center;
      border: 4px solid var(--primary);
      box-shadow: 10px 10px 0px var(--secondary);
      transform: scale(0.9);
      transition: transform 0.3s ease;
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
    }
    .modal-overlay.active .modal-content { transform: scale(1); }
    .modal-content h2 {
      color: var(--primary);
      font-size: 3rem;
      margin-bottom: 1.5rem;
      background: none;
      border: none;
      padding: 0;
      font-family: 'Press Start 2P', cursive;
    }
    .modal-content p {
      font-family: 'Noto Sans KR', sans-serif;
      color: var(--text-light);
      font-size: 1.8rem;
      margin-bottom: 2.5rem;
    }
    
    #guide-modal .modal-content {
        text-align: left;
        padding: 3rem 3.5rem;
    }
    #guide-modal h3 {
        text-align: center;
        font-family: 'Press Start 2P', cursive;
        color: var(--correct);
        margin-bottom: 3rem;
        font-size: 2.4rem;
    }
    .guide-steps {
        display: flex;
        flex-direction: column;
        gap: 2.5rem;
    }
    .guide-step {
        display: flex;
        align-items: flex-start;
        gap: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px dotted var(--secondary);
    }
    .guide-steps .guide-step:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    .guide-label {
        font-family: 'Press Start 2P', cursive;
        color: var(--primary);
        font-size: 1.4rem;
        flex-shrink: 0;
        padding-top: 2px;
    }
    .guide-text {
        font-size: 1.6rem;
        line-height: 1.7;
    }
    .guide-text strong {
        color: var(--revealed);
        font-weight: 700;
    }
    #guide-modal .tip {
        font-size: 1.4rem;
        text-align: center;
        color: var(--text-dark);
        margin-top: 3rem;
        background: var(--secondary);
        padding: 1rem;
        border-radius: 8px;
    }
    #close-guide-btn {
        display: block;
        margin: 2.5rem auto 0;
        font-family: 'Press Start 2P', cursive;
    }


    .progress-bar-container {
        width: 100%;
        height: 2.5rem;
        background: var(--bg-dark);
        border: 3px solid var(--secondary);
        margin: 1.5rem 0;
        border-radius: 8px;
    }
    #progress-bar-fill {
        width: 0%;
        height: 100%;
        background: var(--correct);
        transition: width 0.5s ease-out;
        border-radius: 4px;
    }
    #progress-text {
        font-size: 1.8rem !important;
        margin-bottom: 2rem !important;
        color: var(--correct);
    }

    .time-setter, .subject-selector, .mode-selector {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin: 2rem 0;
        flex-wrap: wrap;
    }
    #time-setting-display {
        font-family: 'Source Code Pro', monospace;
        font-size: 3rem;
        color: var(--text-light);
        width: 120px;
        text-align: center;
    }
    .time-control-btn {
        font-size: 2rem;
        padding: 0.5rem 1.5rem;
    }
    .subject-btn, .mode-btn, #random-subject-btn {
        font-size: 1.6rem;
    }
    .subject-btn.selected, .mode-btn.selected {
        background: var(--primary);
        color: var(--text-light);
        transform: translateY(3px);
        box-shadow: 3px 3px 0px var(--secondary);
    }
    
    .subject-btn.is-selecting {
        background: var(--accent);
        transform: scale(1.1) translateY(0);
        box-shadow: 0 0 15px var(--accent);
        transition: all 0.1s ease-in-out;
    }
    #random-subject-btn {
        background-color: #524360; /* 채도가 낮은 보라색 */
    }

    #start-game-btn {
        background-color: var(--primary);
        color: var(--text-light);
        padding: 1.2rem 2.5rem;
        margin-top: 2rem;
        font-size: 1.8rem;
        animation: pulse-start-btn 2s infinite;
    }

    @keyframes pulse-start-btn {
        0% { transform: scale(1); box-shadow: 5px 5px 0px var(--secondary); }
        50% { transform: scale(1.05); box-shadow: 8px 8px 15px var(--secondary); }
        100% { transform: scale(1); box-shadow: 5px 5px 0px var(--secondary); }
    }
    
    #hard-core-description p {
        margin-bottom: 0.5rem;
        font-size: 1.4rem;
    }

    /* Character Assistant Styles */
    #character-assistant {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 80px;
        height: 80px;
        z-index: 99;
        transition: all 0.5s ease-in-out;
    }
    .mushroom {
        width: 100%;
        height: 100%;
        position: relative;
        transition: transform 0.3s ease-out;
    }
    .mushroom-cap {
        width: 100%;
        height: 65%;
        background: #d9534f;
        border: 3px solid #000;
        border-radius: 50% 50% 20% 20%;
        position: absolute;
        top: 0;
        z-index: 2;
        transition: background-color 0.3s, box-shadow 0.3s;
    }
    .mushroom-cap .dot {
        position: absolute;
        width: 15px;
        height: 15px;
        background: white;
        border-radius: 50%;
        border: 2px solid #000;
    }
    .mushroom-cap .dot:nth-child(1) { top: 15%; left: 25%; }
    .mushroom-cap .dot:nth-child(2) { top: 30%; left: 60%; }
    .mushroom-cap .dot:nth-child(3) { top: 45%; left: 20%; }
    
    .mushroom-stem {
        width: 50%;
        height: 50%;
        background: #f7e5d3;
        border: 3px solid #000;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1;
    }
    .character-eye {
        position: absolute;
        width: 6px;
        height: 8px;
        background-color: #000;
        border-radius: 50%;
        top: 40%;
        transition: all 0.2s ease;
        z-index: 3;
    }
    .character-eye.left { left: 30%; }
    .character-eye.right { right: 30%; }

    .spore {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        opacity: 0;
        animation: spore-float 1.2s ease-out forwards;
    }

    /* Character Animations */
    #character-assistant.idle .mushroom { animation: idle-sway 3s ease-in-out infinite; }
    @keyframes idle-sway { 
        0%, 100% { transform: rotate(0deg); } 
        50% { transform: rotate(10deg); } 
    }

    #character-assistant.happy .mushroom { animation: happy-hop 0.6s ease-out; }
    @keyframes happy-hop {
        0%, 100% { transform: translateY(0) scale(1, 1); }
        20% { transform: translateY(5px) scale(1.1, 0.9); } /* Squish down */
        50% { transform: translateY(-20px) scale(0.9, 1.1); } /* Jump up and stretch */
        80% { transform: translateY(2px) scale(1.05, 0.95); } /* Land and squish again */
    }

    @keyframes spore-float {
        0% { transform: translate(0, 0) scale(0); opacity: 0.5; }
        20% { transform: translate(var(--x-1), -20px) scale(1); opacity: 1; }
        100% { transform: translate(var(--x-2), -80px) scale(0); opacity: 0; }
    }

    #character-assistant.sad .mushroom-cap { background-color: #533483; }
    #character-assistant.sad .mushroom { transform: rotate(-15deg) translateY(5px); }
    
    #character-assistant.worried .mushroom { animation: worried-shake 0.3s linear infinite; }
    @keyframes worried-shake { 
        0%, 100% { transform: translateX(0); } 
        25% { transform: translateX(-2px); } 
        75% { transform: translateX(2px); } 
    }

    #character-assistant.cheer .mushroom { animation: cheer-dance 1.2s ease-in-out infinite; }
    @keyframes cheer-dance { 
        0%, 100% { transform: rotate(0); } 
        25% { transform: rotate(-20deg); } 
        75% { transform: rotate(20deg); } 
    }

    /* Combo Growth Styles */
    #character-assistant.combo-level-1 .mushroom { transform: scale(1.1); }
    #character-assistant.combo-level-2 .mushroom { transform: scale(1.2); }
    #character-assistant.combo-level-2 .mushroom-cap { box-shadow: 0 0 10px gold, 0 0 15px gold; }
    #character-assistant.combo-level-3 .mushroom { transform: scale(1.3); }
    #character-assistant.combo-level-3 .mushroom-cap { animation: rainbow-glow 2s infinite alternate; }
    
    @keyframes rainbow-glow {
        0% { box-shadow: 0 0 8px #ff0000, 0 0 12px #ff7f00; }
        20% { box-shadow: 0 0 8px #ff7f00, 0 0 12px #ffff00; }
        40% { box-shadow: 0 0 8px #ffff00, 0 0 12px #00ff00; }
        60% { box-shadow: 0 0 8px #00ff00, 0 0 12px #0000ff; }
        80% { box-shadow: 0 0 8px #0000ff, 0 0 12px #4b0082; }
        100% { box-shadow: 0 0 8px #4b0082, 0 0 12px #9400d3; }
    }
    
    /* Devil Mode Styles */
    .devil-horns, .fire-effect { display: none; }
    #character-assistant.devil-mode .devil-horns { display: block; }
    #character-assistant.devil-mode .mushroom-cap { background: #a00000; }
    #character-assistant.devil-mode.happy .fire-effect { display: flex; }
    
    #character-assistant.devil-mode.sad .mushroom-cap {
        background: #2c003e; /* Very dark, menacing purple */
        box-shadow: 0 0 15px #ff0000, inset 0 0 10px #000;
    }
    #character-assistant.devil-mode.sad .character-eye {
        background: #ff0000; /* Glowing red eyes */
        box-shadow: 0 0 10px #ff0000;
    }

    .devil-horns {
        position: absolute;
        width: 100%;
        top: -5px;
        z-index: 3;
    }
    .horn {
        position: absolute;
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 20px solid #4d0000;
    }
    .horn.left { left: 10px; transform: rotate(-20deg); }
    .horn.right { right: 10px; transform: rotate(20deg); }
    
    .fire-effect {
        position: absolute;
        bottom: 0px;
        left: 50%;
        transform: translateX(-50%);
        width: 150%;
        height: 50px;
        justify-content: center;
        filter: blur(1px);
        z-index: 0;
    }
    .flame {
        width: 15px;
        height: 25px;
        background: orangered;
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        animation: burn 0.8s forwards infinite;
        margin: 0 -4px;
    }
    .flame:nth-child(2) { animation-delay: 0.2s; }
    .flame:nth-child(3) { animation-delay: 0.1s; }
    .flame:nth-child(4) { animation-delay: 0.3s; }
    .flame:nth-child(5) { animation-delay: 0.15s; }

    @keyframes burn {
        0% { transform: translateY(0) scale(1); opacity: 0.9; }
        50% { transform: translateY(-40px) scale(1.5); opacity: 1; }
        100% { transform: translateY(-80px) scale(0); opacity: 0; }
    }
    
    #lives-container:not(.hidden) {
        display: flex;
        gap: 0.5rem;
    }
    .heart-icon {
        font-size: 2rem;
        color: var(--primary);
        transition: color 0.3s;
    }
    .heart-icon.lost {
        color: #555;
    }
    
    /* Result Modal Enhancements */
    #progress-modal .modal-content {
        position: relative;
        padding-top: 1rem;
    }
    #result-character-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 2rem;
        margin-bottom: 2rem;
        min-height: 100px;
    }
    #modal-character-placeholder {
        width: 80px;
        height: 80px;
        position: relative;
    }
    #modal-character-placeholder > #character-assistant {
        position: static; /* Override fixed positioning */
        bottom: auto;
        right: auto;
    }
    .speech-bubble {
        position: relative;
        background: var(--bg-dark);
        border-radius: .4em;
        padding: 1.5rem;
        min-width: 250px;
        max-width: 300px;
        text-align: left;
        border: 2px solid var(--primary);
    }
    .speech-bubble:after {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        width: 0;
        height: 0;
        border: 20px solid transparent;
        border-right-color: var(--primary);
        border-left: 0;
        border-bottom: 0;
        margin-top: -10px;
        margin-left: -22px;
    }
    #result-dialogue {
        margin: 0;
        font-size: 1.6rem;
        line-height: 1.6;
    }
    #result-title {
        font-size: 2.5rem !important;
        margin-bottom: 1rem !important;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        :root {
            font-size: 8px;
        }
        header {
            padding: 1rem;
            flex-direction: column;
            height: auto;
            gap: 1rem;
        }
        .hud-left, .hud-center, .hud-right {
            flex: none;
            width: 100%;
            justify-content: center;
        }
        .hud-right {
            flex-wrap: wrap;
        }
        header h1 {
            margin-bottom: 1rem;
        }
        main {
            padding-top: 22rem; /* Adjust based on new header height */
        }
        .tabs {
            flex-wrap: wrap;
        }
        .tab {
            flex-basis: 45%;
        }
        .grade-container {
            flex-direction: column;
        }
        #character-assistant {
            width: 60px;
            height: 60px;
            bottom: 10px;
            right: 10px;
        }
    }
    @media (max-width: 480px) {
        .hud-center {
            flex-direction: column;
        }
        main {
            padding-top: 28rem;
        }
        #result-character-container {
            flex-direction: column;
        }
        .speech-bubble:after {
            top: 0;
            left: 50%;
            border: 20px solid transparent;
            border-bottom-color: var(--primary);
            border-top: 0;
            border-right: 0;
            margin-left: -10px;
            margin-top: -20px;
        }
    }

  </style>
</head>
<body>
  <header>
    <div class="hud-left">
        <h1 id="header-title">내체표 아웃풋</h1>
        <div id="combo-counter" class="hidden"></div>
    </div>
    <div class="hud-center">
        <div id="lives-container" class="hidden">
            <span class="heart-icon">♥</span>
            <span class="heart-icon">♥</span>
            <span class="heart-icon">♥</span>
        </div>
        <div id="timer-container" class="kitsch-box hidden">
            <div id="time">10:00</div>
            <div id="bar"><div></div></div>
        </div>
    </div>
    <div class="hud-right">
      <button id="force-quit-btn" class="btn hidden">강제 종료</button>
      <button id="show-answers-btn" class="btn hidden">정답 보기</button>
      <button id="reset-btn" class="btn hidden">재시작</button>
    </div>
  </header>
  <main id="music-quiz-main" class="hidden">
    <div class="tabs">
      <div class="tab active" data-target="performance">연주</div>
      <div class="tab" data-target="listening">감상</div>
      <div class="tab" data-target="creation">창작</div>
      <div class="tab" data-target="elements">음악 요소</div>
    </div>
    <section id="performance" class="active">
      <h2>연주</h2>
      <div class="grade-container">
        <div>
          <div class="grade-title">3~4학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="생활 속의 음악" placeholder="정답">
                  <input data-answer="기초적인 음악 요소" placeholder="정답">
                  <input data-answer="자세와 주법" placeholder="정답">
                  <input data-answer="느낌, 여러 소리" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="노래 부르거나 악기 연주하기" placeholder="정답">
                  <input data-answer="신체로 표현하고 놀이하기" placeholder="정답">
                  <input data-answer="발표하고 이야기하기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="연주를 즐기는 태도" placeholder="정답">
                  <input data-answer="연주에 대한 관심" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="grade-title">5~6학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="간단한 악곡의 연주 형태" placeholder="정답">
                  <input data-answer="음악 요소" placeholder="정답">
                  <input data-answer="주법과 표현 기법" placeholder="정답">
                  <input data-answer="어울림, 여러 악기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="노래 부르거나 악기 연주하기" placeholder="정답">
                  <input data-answer="다양한 방법으로 표현하기" placeholder="정답">
                  <input data-answer="발표하고 돌아보기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="음악으로 함께하는 태도" placeholder="정답">
                  <input data-answer="연주 준비와 참여" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="listening">
      <h2>감상</h2>
      <div class="grade-container">
        <div>
          <div class="grade-title">3~4학년</div>
          <table>
              <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="다양한 종류의 음악" placeholder="정답">
                  <input data-answer="지역의 음악 문화유산" placeholder="정답">
                  <input data-answer="기초적인 음악 요소" placeholder="정답">
                  <input data-answer="음악적 특징" placeholder="정답">
                  <input data-answer="느낌, 분위기, 쓰임" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="반응하며 듣기" placeholder="정답">
                  <input data-answer="탐색하고 발견하기" placeholder="정답">
                  <input data-answer="묘사하거나 이야기하기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="소리와 음악을 즐기는 태도" placeholder="정답">
                  <input data-answer="음악에 대한 호기심" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="grade-title">5~6학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="다양한 종류와 문화권의 음악" placeholder="정답">
                  <input data-answer="우리나라 음악 문화유산" placeholder="정답">
                  <input data-answer="음악 요소" placeholder="정답">
                  <input data-answer="음악적 특징, 음악의 간단한 구성" placeholder="정답">
                  <input data-answer="느낌, 배경, 활용" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="감상하며 듣기" placeholder="정답">
                  <input data-answer="인식하고 구별하기" placeholder="정답">
                  <input data-answer="설명하기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="음악의 아름다움에 대한 인식" placeholder="정답">
                  <input data-answer="음악에 대한 공감" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="creation">
      <h2>창작</h2>
      <div class="grade-container">
        <div>
          <div class="grade-title">3~4학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="소리와 음악" placeholder="정답">
                  <input data-answer="기초적인 음악 요소" placeholder="정답">
                  <input data-answer="간단한 악보" placeholder="정답">
                  <input data-answer="느낌, 상상" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="즉흥적으로 표현하기" placeholder="정답">
                  <input data-answer="부분적으로 바꾸기" placeholder="정답">
                  <input data-answer="모방하여 나타내기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="음악에 대한 흥미" placeholder="정답">
                  <input data-answer="음악의 새로움을 즐기는 태도" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="grade-title">5~6학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="간단한 음악" placeholder="정답">
                  <input data-answer="음악 요소" placeholder="정답">
                  <input data-answer="기초적인 기보, 음악 매체" placeholder="정답">
                  <input data-answer="느낌, 아이디어" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="떠올리며 표현하기" placeholder="정답">
                  <input data-answer="간단한 조건에 따라 바꾸기" placeholder="정답">
                  <input data-answer="활용하여 만들기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="음악에 대한 자신감" placeholder="정답">
                  <input data-answer="음악에 대한 열린 태도" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="elements">
      <h2>음악 요소</h2>
      <div class="grade-container">
        <div>
          <div class="grade-title">3~4학년</div>
          <table>
            <tbody>
              <tr>
                <th>리듬</th>
                <td>
                  <input data-answer="박, 박자" placeholder="정답">
                  <input data-answer="장단, 장단의 세" placeholder="정답">
                  <input data-answer="음의 길고 짧음" placeholder="정답">
                  <input data-answer="간단한 리듬꼴" placeholder="정답">
                  <input data-answer="장단꼴" placeholder="정답">
                  <input data-answer="말붙임새" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가락</th>
                <td>
                  <input data-answer="음의 높고 낮음" placeholder="정답">
                  <input data-answer="차례가기와 뛰어가기" placeholder="정답">
                  <input data-answer="시김새" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>화성</th>
                <td><input data-answer="소리의 어울림" placeholder="정답"></td>
              </tr>
              <tr>
                <th>형식</th>
                <td><input data-answer="형식(메기고 받는 형식, ab 등)" placeholder="정답"></td>
              </tr>
              <tr>
                <th>셈여림</th>
                <td><input data-answer="셈여림" placeholder="정답"></td>
              </tr>
              <tr>
                <th>빠르기</th>
                <td><input data-answer="빠르기/한배" placeholder="정답"></td>
              </tr>
              <tr>
                <th>음색</th>
                <td><input data-answer="목소리, 물체 소리, 타악기의 음색" placeholder="정답"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="grade-title">5~6학년</div>
          <table>
            <tbody>
              <tr>
                <th>리듬</th>
                <td>
                  <input data-answer="박, 박자" placeholder="정답">
                  <input data-answer="장단, 장단의 세" placeholder="정답">
                  <input data-answer="여러 가지 리듬꼴" placeholder="정답">
                  <input data-answer="장단꼴" placeholder="정답">
                  <input data-answer="말붙임새" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가락</th>
                <td>
                  <input data-answer="음이름, 계이름, 음명" placeholder="정답">
                  <input data-answer="장음계, 단음계" placeholder="정답">
                  <input data-answer="여러 지역의 토리" placeholder="정답">
                  <input data-answer="시김새" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>화성</th>
                <td>
                  <input data-answer="주요 3화음" placeholder="정답">
                  <input data-answer="다양한 소리의 어울림" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>형식</th>
                <td><input data-answer="형식(긴자진 형식, 시조 형식, aba, AB 등)" placeholder="정답"></td>
              </tr>
              <tr>
                <th>셈여림</th>
                <td><input data-answer="셈여림의 변화" placeholder="정답"></td>
              </tr>
              <tr>
                <th>빠르기</th>
                <td><input data-answer="빠르기의 변화/한배의 변화" placeholder="정답"></td>
              </tr>
              <tr>
                <th>음색</th>
                <td><input data-answer="관악기, 현악기의 음색" placeholder="정답"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  
  <main id="art-quiz-main" class="hidden">
    <div class="tabs">
      <div class="tab active" data-target="aesthetic-experience">미적체험</div>
      <div class="tab" data-target="expression">표현</div>
      <div class="tab" data-target="appreciation">감상</div>
    </div>
    <section id="aesthetic-experience" class="active">
      <h2>미적체험</h2>
      <div class="grade-container">
        <div>
          <div class="grade-title">3~4학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="자신의 감각" placeholder="정답">
                  <input data-answer="대상의 특징" placeholder="정답">
                  <input data-answer="생활 속 미술" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="감각을 활용하여 탐색하기" placeholder="정답">
                  <input data-answer="대상에 반응하여 느낌과 생각을 나타내기" placeholder="정답">
                  <input data-answer="미술의 특징과 역할을 발견하기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="미적 탐색에 대한 호기심" placeholder="정답">
                  <input data-answer="미술의 역할에 관한 관심" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div>
          <div class="grade-title">5~6학년</div>
          <table>
            <tbody>
              <tr>
                <th>지식 · 이해</th>
                <td>
                  <input data-answer="감각과 매체의 역할" placeholder="정답">
                  <input data-answer="자신과 환경의 관계" placeholder="정답">
                  <input data-answer="이미지와 의미" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>과정 · 기능</th>
                <td>
                  <input data-answer="감각과 매체을 활용하여 탐색하기" placeholder="정답">
                  <input data-answer="대상과 상호 작용하며 의미 발견하기" placeholder="정답">
                  <input data-answer="이미지을 해석하고 활용하기" placeholder="정답">
                </td>
              </tr>
              <tr>
                <th>가치 · 태도</th>
                <td>
                  <input data-answer="주변 환경에 대한 민감성" placeholder="정답">
                  <input data-answer="비판적으로 이해하는 태도" placeholder="정답">
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    <section id="expression">
        <h2>표현</h2>
        <div class="grade-container">
            <div>
                <div class="grade-title">3~4학년</div>
                <table>
                    <tbody>
                        <tr><th>지식 · 이해</th><td><input data-answer="표현 주제" placeholder="정답"><input data-answer="기본적인 표현 재료와 용구" placeholder="정답"><input data-answer="조형 요소의 특징" placeholder="정답"></td></tr>
                        <tr><th>과정 · 기능</th><td><input data-answer="관찰과 상상으로 아이디어를 떠올리기" placeholder="정답"><input data-answer="표현 방법을 익히기" placeholder="정답"><input data-answer="의도을 가지고 작품을 제작하기" placeholder="정답"><input data-answer="타 교과와 관련짓기" placeholder="정답"></td></tr>
                        <tr><th>가치 · 태도</th><td><input data-answer="표현에 대한 흥미" placeholder="정답"><input data-answer="자기 작품을 소중히 여기는 태도" placeholder="정답"></td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <div class="grade-title">5~6학년</div>
                <table>
                    <tbody>
                        <tr><th>지식 · 이해</th><td><input data-answer="표현 주제와 발상" placeholder="정답"><input data-answer="표현 재료와 용구, 디지털 매체" placeholder="정답"><input data-answer="조형 요소와 원리의 관계" placeholder="정답"></td></tr>
                        <tr><th>과정 · 기능</th><td><input data-answer="다양한 방법으로 아이디어를 연결하기" placeholder="정답"><input data-answer="표현 방법을 탐색하여 활용하기" placeholder="정답"><input data-answer="과정을 돌아보며 작품을 발전시키기" placeholder="정답"><input data-answer="타 교과와 융합하기" placeholder="정답"></td></tr>
                        <tr><th>가치 · 태도</th><td><input data-answer="주제 표현의 의지" placeholder="정답"><input data-answer="자유롭게 시도하는 태도" placeholder="정답"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="appreciation">
        <h2>감상</h2>
        <div class="grade-container">
            <div>
                <div class="grade-title">3~4학년</div>
                <table>
                    <tbody>
                        <tr><th>지식 · 이해</th><td><input data-answer="미술 작품과 미술가" placeholder="정답"><input data-answer="미술 작품의 특징" placeholder="정답"><input data-answer="미술 전시" placeholder="정답"></td></tr>
                        <tr><th>과정 · 기능</th><td><input data-answer="자세히 보고 질문하기" placeholder="정답"><input data-answer="미술 작품에 관한 느낌과 생각을 설명하기" placeholder="정답"><input data-answer="미술 전시 및 행사에 참여하기" placeholder="정답"></td></tr>
                        <tr><th>가치 · 태도</th><td><input data-answer="자신의 감상 관점 존중" placeholder="정답"><input data-answer="미술 문화에 관한 관심" placeholder="정답"></td></tr>
                    </tbody>
                </table>
            </div>
            <div>
                <div class="grade-title">5~6학년</div>
                <table>
                    <tbody>
                        <tr><th>지식 · 이해</th><td><input data-answer="미술 작품의 배경" placeholder="정답"><input data-answer="미술 작품의 내용과 형식" placeholder="정답"><input data-answer="공동체의 미술 문화" placeholder="정답"></td></tr>
                        <tr><th>과정 · 기능</th><td><input data-answer="작품과 배경을 연결하기" placeholder="정답"><input data-answer="다양한 방법으로 분석하기" placeholder="정답"><input data-answer="미술 문화 활동을 경험하고 공유하기" placeholder="정답"></td></tr>
                        <tr><th>가치 · 태도</th><td><input data-answer="서로 다른 관점의 존중" placeholder="정답"><input data-answer="공동체 문화에 참여" placeholder="정답"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
  </main>
  
  <main id="korean-quiz-main" class="hidden">
    <div class="tabs">
      <div class="tab active" data-target="listening-speaking">듣기·말하기</div>
      <div class="tab" data-target="reading">읽기</div>
      <div class="tab" data-target="writing">쓰기</div>
      <div class="tab" data-target="grammar">문법</div>
      <div class="tab" data-target="literature">문학</div>
      <div class="tab" data-target="media">매체</div>
    </div>
    <section id="listening-speaking" class="active">
        <h2>듣기·말하기</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="듣기·말하기 맥락" placeholder="정답">
                                <input data-answer="담화 유형" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="내용 확인·추론·평가" placeholder="정답">
                                <input data-answer="내용 생성·조직·표현과 전달" placeholder="정답">
                                <input data-answer="상호 작용" placeholder="정답">
                                <input data-answer="점검과 조정" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="reading">
        <h2>읽기</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="읽기 맥락" placeholder="정답">
                                <input data-answer="글의 유형" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="읽기의 기초" placeholder="정답">
                                <input data-answer="내용 확인과 추론" placeholder="정답">
                                <input data-answer="평가와 창의" placeholder="정답">
                                <input data-answer="점검과 조정" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="writing">
        <h2>쓰기</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="쓰기 맥락" placeholder="정답">
                                <input data-answer="글의 유형" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="쓰기의 기초" placeholder="정답">
                                <input data-answer="계획하기" placeholder="정답">
                                <input data-answer="내용 생성하기" placeholder="정답">
                                <input data-answer="내용 조직하기" placeholder="정답">
                                <input data-answer="표현하기" placeholder="정답">
                                <input data-answer="공유하기" placeholder="정답">
                                <input data-answer="점검과 조정" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="grammar">
        <h2>문법</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="언어의 본질과 맥락" placeholder="정답">
                                <input data-answer="언어 단위" placeholder="정답">
                                <input data-answer="한글의 기초와 국어 규범" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="국어의 분석과 활용" placeholder="정답">
                                <input data-answer="국어 실천의 성찰과 비판" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="literature">
        <h2>문학</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="갈래" placeholder="정답">
                                <input data-answer="맥락" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="작품 읽기와 이해" placeholder="정답">
                                <input data-answer="해석과 감상" placeholder="정답">
                                <input data-answer="비평" placeholder="정답">
                                <input data-answer="창작" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
    <section id="media">
        <h2>매체</h2>
        <div class="grade-container">
            <div>
                <table>
                    <tbody>
                        <tr>
                            <th>지식 · 이해</th>
                            <td>
                                <input data-answer="매체 소통 맥락" placeholder="정답">
                                <input data-answer="매체 자료 유형" placeholder="정답">
                            </td>
                        </tr>
                        <tr>
                            <th>과정 · 기능</th>
                            <td>
                                <input data-answer="접근과 선택" placeholder="정답">
                                <input data-answer="해석과 평가" placeholder="정답">
                                <input data-answer="제작과 공유" placeholder="정답">
                                <input data-answer="점검과 조정" placeholder="정답">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
  </main>

  <div id="character-assistant" class="idle">
      <div class="mushroom">
          <div class="devil-horns">
              <div class="horn left"></div>
              <div class="horn right"></div>
          </div>
          <div class="mushroom-cap">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="spore-container"></div>
          </div>
          <div class="mushroom-stem">
              <div class="character-eye left"></div>
              <div class="character-eye right"></div>
          </div>
          <div class="fire-effect">
              <div class="flame"></div><div class="flame"></div><div class="flame"></div><div class="flame"></div><div class="flame"></div>
          </div>
      </div>
  </div>

  <div id="stage-clear-modal" class="modal-overlay">
    <div class="modal-content">
      <h2>Stage Clear!</h2>
      <p>축하합니다! 이 영역을 마스터했습니다!</p>
      <button id="close-modal-btn" class="btn">닫기</button>
    </div>
  </div>
  
  <div id="progress-modal" class="modal-overlay">
      <div class="modal-content">
          <div id="result-character-container">
              <div id="modal-character-placeholder"></div>
              <div class="speech-bubble hidden">
                  <p id="result-dialogue"></p>
              </div>
          </div>
          <h2 id="result-title">게임 결과</h2>
          <p>맞춘 개수: <span id="correct-count">0</span> / <span id="total-count">0</span></p>
          <div class="progress-bar-container">
              <div id="progress-bar-fill"></div>
          </div>
          <p id="progress-text">0%</p>
          <button id="close-progress-modal-btn" class="btn">확인</button>
      </div>
  </div>
  
  <div id="guide-modal" class="modal-overlay">
      <div class="modal-content">
          <h3>HOW TO PLAY</h3>
          <div class="guide-steps">
              <div class="guide-step">
                  <div class="guide-label">STEP 1</div>
                  <div class="guide-text"><strong>설정:</strong> 학습할 과목, 모드, 시간을 선택하세요.</div>
              </div>
              <div class="guide-step">
                  <div class="guide-label">STEP 2</div>
                  <div class="guide-text"><strong>시작:</strong> '시작' 버튼을 눌러 게임을 시작!</div>
              </div>
              <div class="guide-step">
                  <div class="guide-label">STEP 3</div>
                  <div class="guide-text"><strong>채점:</strong> 빈칸에 정답을 입력하면 즉시 채점됩니다.</div>
              </div>
              <div class="guide-step">
                  <div class="guide-label">STEP 4</div>
                  <div class="guide-text"><strong>복습:</strong> 게임 종료 후, '정답 보기'로 복습하세요.</div>
              </div>
          </div>
          <p class="tip">※ 채점 시 띄어쓰기와 ⋅ 기호는 무시됩니다.</p>
          <button id="close-guide-btn" class="btn">OK!</button>
      </div>
  </div>

  <div id="start-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>과목 선택</h2>
            <div class="subject-selector">
                <button class="btn subject-btn selected" data-subject="music">음악</button>
                <button class="btn subject-btn" data-subject="art">미술</button>
                <button class="btn subject-btn" data-subject="korean">국어</button>
                <button id="random-subject-btn" class="btn" data-subject="random">랜덤</button>
            </div>
            <h2>게임 모드</h2>
            <div class="mode-selector">
                <button class="btn mode-btn selected" data-mode="normal">기본 모드</button>
                <button class="btn mode-btn" data-mode="hard-core">하드 코어</button>
            </div>
            <div id="time-setter-wrapper">
                <h2>제한 시간 선택</h2>
                <div class="time-setter">
                    <button id="decrease-time" class="btn time-control-btn">-</button>
                    <div id="time-setting-display">10:00</div>
                    <button id="increase-time" class="btn time-control-btn">+</button>
                </div>
            </div>
            <div id="hard-core-description" class="notice-text hidden">
                <p>3번 틀리면 게임이 즉시 종료됩니다.<br>(제한시간 30초, 정답 시 +3초)</p>
            </div>
            <button id="start-game-btn" class="btn">시작</button>
        </div>
    </div>


  <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- AudioContext for Autoplay Policy ---
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function unlockAudio() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            document.body.removeEventListener('click', unlockAudio);
            document.body.removeEventListener('touchend', unlockAudio);
        }
        document.body.addEventListener('click', unlockAudio);
        document.body.addEventListener('touchend', unlockAudio);


        // --- CONSTANTS ---
        const CONSTANTS = {
            SUBJECTS: {
                MUSIC: 'music',
                ART: 'art',
                KOREAN: 'korean',
                RANDOM: 'random'
            },
            MODES: {
                NORMAL: 'normal',
                HARD_CORE: 'hard-core'
            },
            CSS_CLASSES: {
                HIDDEN: 'hidden',
                CORRECT: 'correct',
                INCORRECT: 'incorrect',
                RETRYING: 'retrying',
                REVEALED: 'revealed',
                SELECTED: 'selected',
                IS_SELECTING: 'is-selecting',
                ACTIVE: 'active',
                LOST: 'lost',
                COMBO_POP: 'combo-pop'
            },
            DEFAULT_DURATION: 600,
            HARD_CORE_DURATION: 30, 
            HARD_CORE_LIVES: 3,
            HARD_CORE_TIME_BONUS: 3,
            RANDOM_ANIMATION_DURATION: 2000,
            RANDOM_ANIMATION_INTERVAL: 100
        };

        // --- GAME STATE ---
        const gameState = {
            duration: CONSTANTS.DEFAULT_DURATION,
            total: CONSTANTS.DEFAULT_DURATION,
            timerId: null,
            combo: 0,
            lives: CONSTANTS.HARD_CORE_LIVES,
            selectedSubject: CONSTANTS.SUBJECTS.MUSIC,
            gameMode: CONSTANTS.MODES.NORMAL,
            isRandomizing: false,
            typingInterval: null
        };

        // --- DOM Elements ---
        const timeEl = document.getElementById('time');
        const barEl = document.querySelector('#bar > div');
        const comboCounter = document.getElementById('combo-counter');
        const showAnswersBtn = document.getElementById('show-answers-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const forceQuitBtn = document.getElementById('force-quit-btn');
        const resetBtn = document.getElementById('reset-btn');
        const character = document.getElementById('character-assistant');
        const headerTitle = document.getElementById('header-title');
        const livesContainer = document.getElementById('lives-container');
        const stageClearModal = document.getElementById('stage-clear-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const progressModal = document.getElementById('progress-modal');
        const closeProgressModalBtn = document.getElementById('close-progress-modal-btn');
        const startModal = document.getElementById('start-modal');
        const guideModal = document.getElementById('guide-modal');
        const closeGuideBtn = document.getElementById('close-guide-btn');
        const timeSettingDisplay = document.getElementById('time-setting-display');
        const decreaseTimeBtn = document.getElementById('decrease-time');
        const increaseTimeBtn = document.getElementById('increase-time');
        const timeSetterWrapper = document.getElementById('time-setter-wrapper');
        const subjectSelector = document.querySelector('.subject-selector');
        const quizContainers = document.querySelectorAll('main[id$="-quiz-main"]');
        const modalCharacterPlaceholder = document.getElementById('modal-character-placeholder');
        const speechBubble = document.querySelector('.speech-bubble');
        const resultDialogue = document.getElementById('result-dialogue');
        const resultTitle = document.getElementById('result-title');
        
        // --- Audio ---
        const successAudio = new Audio('./success.mp3');
        successAudio.preload = 'auto';
        const timeupAudio = new Audio('./timeup.mp3');
        timeupAudio.preload = 'auto';
        const startAudio = new Audio('./start.mp3');
        startAudio.preload = 'auto';
        const failAudio = new Audio('./fail.mp3');
        failAudio.preload = 'auto';
        const clearAudio = new Audio('./clear.mp3');
        clearAudio.preload = 'auto';
        const randomAudio = new Audio('./random.mp3');
        randomAudio.preload = 'auto';
        const clickAudio = new Audio('./click.mp3');
        clickAudio.preload = 'auto';
        
        // --- UTILITY FUNCTIONS ---
        const fmt = n => String(n).padStart(2, '0');
        const formatTime = s => `${fmt(Math.floor(s / 60))}:${fmt(s % 60)}`;

        function playSound(audioElement) {
            if (audioContext.state === 'running' && audioElement && typeof audioElement.play === 'function') {
                audioElement.currentTime = 0;
                audioElement.play().catch(err => {
                    console.error(`Audio playback failed for ${audioElement.src}:`, err);
                });
            } else if (audioElement && typeof audioElement.play !== 'function') {
                 console.error("Provided element is not a valid audio element.");
            }
        }

        function typewriter(element, text) {
            if (gameState.typingInterval) {
                clearInterval(gameState.typingInterval);
            }
            element.textContent = '';
            let i = 0;
            gameState.typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                } else {
                    clearInterval(gameState.typingInterval);
                    gameState.typingInterval = null;
                }
            }, 50);
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateTimeSettingDisplay() {
            timeSettingDisplay.textContent = formatTime(gameState.duration);
        }

        function updateLivesUI() {
            const heartIcons = livesContainer.querySelectorAll('.heart-icon');
            heartIcons.forEach((heart, index) => {
                heart.classList.toggle(CONSTANTS.CSS_CLASSES.LOST, index >= gameState.lives);
            });
        }

        function setCharacterState(state, duration = 1500) {
            character.className = '';
            character.classList.add(state);
            if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                character.classList.add('devil-mode');
            }
            
            updateMushroomGrowth();

            if (state === 'happy' || state === 'sad') {
                setTimeout(() => {
                    const baseState = (gameState.total > 0 && gameState.total < 30 && gameState.gameMode !== CONSTANTS.MODES.HARD_CORE) ? 'worried' : 'idle';
                    character.className = '';
                    character.classList.add(baseState);
                    if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                        character.classList.add('devil-mode');
                    }
                    updateMushroomGrowth();
                }, duration);
            }
        }
        
        function updateMushroomGrowth() {
            character.classList.remove('combo-level-1', 'combo-level-2', 'combo-level-3');
            if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) return;
            
            if (gameState.combo >= 10) character.classList.add('combo-level-3');
            else if (gameState.combo >= 5) character.classList.add('combo-level-2');
            else if (gameState.combo >= 2) character.classList.add('combo-level-1');
        }

        function showProgress() {
            const allInputs = document.querySelectorAll(`#${gameState.selectedSubject}-quiz-main input[data-answer]`);
            const correctCount = document.querySelectorAll(`#${gameState.selectedSubject}-quiz-main input.${CONSTANTS.CSS_CLASSES.CORRECT}`).length;
            const totalCount = allInputs.length;
            const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;

            document.getElementById('correct-count').textContent = correctCount;
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('progress-text').textContent = `${percentage}%`;
            
            const progressBarFill = document.getElementById('progress-bar-fill');
            
            let feedback;
            if (percentage === 100) {
                feedback = { title: "신의 경지", dialogue: "완벽해! 당신은 이 게임의 신이야!", animation: "cheer", effect: "perfect" };
            } else if (percentage >= 90) {
                feedback = { title: "내체표 마스터", dialogue: "대단한 실력인데? 거의 마스터 수준이야!", animation: "happy", effect: "excellent" };
            } else if (percentage >= 70) {
                feedback = { title: "내체표 고수", dialogue: "꽤 하는걸? 이 감각, 잊지 말라구!", animation: "idle", effect: "great" };
            } else if (percentage >= 50) {
                feedback = { title: "내체표 중수", dialogue: "절반은 넘었네! 다음엔 더 잘할 수 있겠어.", animation: "idle", effect: "good" };
            } else if (percentage >= 20) {
                feedback = { title: "내체표 하수", dialogue: "으... 너무 어려웠어. 다시 해볼까?", animation: "sad", effect: "notbad" };
            } else {
                feedback = { title: "내체표 입문자", dialogue: "털썩... (아무 말도 하지 못했다)", animation: "sad", effect: "tryagain" };
            }

            resultTitle.textContent = feedback.title;
            
            modalCharacterPlaceholder.innerHTML = '';
            modalCharacterPlaceholder.appendChild(character.cloneNode(true));
            
            setTimeout(() => {
                const modalChar = modalCharacterPlaceholder.querySelector('#character-assistant');
                modalChar.className = '';
                modalChar.classList.add(feedback.animation);
                 if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                    modalChar.classList.add('devil-mode');
                }
            }, 100);

            speechBubble.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            typewriter(resultDialogue, feedback.dialogue);
            
            progressModal.classList.add(CONSTANTS.CSS_CLASSES.ACTIVE);
            setTimeout(() => { progressBarFill.style.width = `${percentage}%`; }, 100);
        }

        // --- GAME LOGIC FUNCTIONS ---
        function handleGameOver() {
            clearInterval(gameState.timerId);
            gameState.timerId = null;
            document.querySelectorAll(`#${gameState.selectedSubject}-quiz-main input[data-answer]`).forEach(i => i.disabled = true);
            playSound(timeupAudio);
            
            gameState.combo = 0;
            updateMushroomGrowth();
            headerTitle.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            comboCounter.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            
            forceQuitBtn.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            setCharacterState('sad');
            showProgress();
        }

        function tick() {
            if (gameState.total <= 0) {
                handleGameOver();
                return;
            }
            gameState.total--;
            timeEl.textContent = formatTime(gameState.total);
            
            let currentDuration = (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) ? CONSTANTS.HARD_CORE_DURATION : gameState.duration;
            barEl.style.width = `${(gameState.total / currentDuration) * 100}%`;

            if (gameState.total < 30 && !character.classList.contains('happy') && !character.classList.contains('sad') && gameState.gameMode !== CONSTANTS.MODES.HARD_CORE) {
                setCharacterState('worried', 1000);
            }
        }

        function resetGame(showStartModal = true) {
            clearInterval(gameState.timerId);
            gameState.timerId = null;
            
            quizContainers.forEach(main => main.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN));
            document.querySelectorAll('input[data-answer]').forEach(i => {
                i.disabled = true;
                i.value = '';
                i.className = '';
            });
            
            gameState.combo = 0;
            updateMushroomGrowth();
            headerTitle.textContent = '내체표 아웃풋';
            headerTitle.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            comboCounter.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            showAnswersBtn.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            showAnswersBtn.disabled = false;
            resetBtn.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            forceQuitBtn.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            document.getElementById('timer-container').classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            livesContainer.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
            
            if (showStartModal) {
                startModal.classList.add(CONSTANTS.CSS_CLASSES.ACTIVE);
            }
            
            setCharacterState('idle');
        }

        function startGame() {
            playSound(startAudio);
            startModal.classList.remove(CONSTANTS.CSS_CLASSES.ACTIVE);
            
            const subjectMap = { [CONSTANTS.SUBJECTS.MUSIC]: '음악', [CONSTANTS.SUBJECTS.ART]: '미술', [CONSTANTS.SUBJECTS.KOREAN]: '국어' };
            headerTitle.textContent = subjectMap[gameState.selectedSubject] || '퀴즈';
            document.getElementById(`${gameState.selectedSubject}-quiz-main`).classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            
            document.querySelectorAll(`#${gameState.selectedSubject}-quiz-main input[data-answer]`).forEach(i => i.disabled = false);
            
            forceQuitBtn.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            
            if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                gameState.duration = CONSTANTS.HARD_CORE_DURATION;
                gameState.lives = CONSTANTS.HARD_CORE_LIVES;
                updateLivesUI();
                livesContainer.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
                document.getElementById('timer-container').classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
                document.getElementById('bar').style.display = 'none';
            } else {
                const timeParts = timeSettingDisplay.textContent.split(':');
                gameState.duration = parseInt(timeParts[0], 10) * 60 + parseInt(timeParts[1], 10);
                livesContainer.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
                document.getElementById('timer-container').classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
                document.getElementById('bar').style.display = 'block';
            }
            gameState.total = gameState.duration;
            timeEl.textContent = formatTime(gameState.total);
            barEl.style.width = '100%';
            if (gameState.timerId === null) {
                gameState.timerId = setInterval(tick, 1000);
            }
            setCharacterState('idle');
            if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                character.classList.add('devil-mode');
            }
        }

        function checkStageClear(sectionElement) {
            const inputsInSection = sectionElement.querySelectorAll('input[data-answer]');
            return inputsInSection.length > 0 && [...inputsInSection].every(input => input.classList.contains(CONSTANTS.CSS_CLASSES.CORRECT));
        }

        function showStageClear() {
            playSound(clearAudio);
            stageClearModal.classList.add(CONSTANTS.CSS_CLASSES.ACTIVE);
            setCharacterState('cheer', 5000);
            
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 201 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } });
                confetti({ ...defaults, particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } });
            }, 250);
        }

        function handleInputChange(e) {
            const input = e.target;
            if (!input.matches('input[data-answer]') || input.disabled) return;

            const userAnswer = input.value.trim().replace(/[\s⋅·]+/g, '').toLowerCase();
            const correctAnswer = input.dataset.answer.trim().replace(/[\s⋅·]+/g, '').toLowerCase();
            
            if (userAnswer === correctAnswer) {
                playSound(successAudio);
                input.classList.remove(CONSTANTS.CSS_CLASSES.INCORRECT, CONSTANTS.CSS_CLASSES.RETRYING);
                input.classList.add(CONSTANTS.CSS_CLASSES.CORRECT);
                input.value = input.dataset.answer;
                input.disabled = true;

                gameState.combo++;
                setCharacterState('happy');
                updateMushroomGrowth();

                if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                    gameState.total += CONSTANTS.HARD_CORE_TIME_BONUS;
                    timeEl.textContent = formatTime(gameState.total);
                }
                
                if (gameState.combo > 1) {
                    headerTitle.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);
                    comboCounter.textContent = `COMBO x${gameState.combo}`;
                    comboCounter.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
                    comboCounter.classList.remove(CONSTANTS.CSS_CLASSES.COMBO_POP);
                    void comboCounter.offsetWidth;
                    comboCounter.classList.add(CONSTANTS.CSS_CLASSES.COMBO_POP);
                }
                
                if (checkStageClear(input.closest('section'))) {
                    setTimeout(showStageClear, 300);
                }
            } else {
                gameState.combo = 0;
                updateMushroomGrowth();
                headerTitle.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
                comboCounter.classList.add(CONSTANTS.CSS_CLASSES.HIDDEN);

                if (input.classList.contains(CONSTANTS.CSS_CLASSES.RETRYING)) {
                    playSound(failAudio);
                    setCharacterState('sad');

                    input.classList.remove(CONSTANTS.CSS_CLASSES.RETRYING);
                    input.classList.add(CONSTANTS.CSS_CLASSES.INCORRECT);
                    
                    input.value = input.dataset.answer;
                    input.disabled = true;
                    
                    if (gameState.gameMode === CONSTANTS.MODES.HARD_CORE) {
                        gameState.lives--;
                        updateLivesUI();
                        if (gameState.lives <= 0) {
                            handleGameOver();
                        }
                    }
                } else {
                    playSound(failAudio);
                    setCharacterState('sad');

                    input.classList.add(CONSTANTS.CSS_CLASSES.RETRYING);
                    input.value = '';
                }
            }
        }

        // --- EVENT LISTENERS ---
        subjectSelector.addEventListener('click', e => {
            if (!e.target.matches('.btn') || gameState.isRandomizing) return;

            const clickedBtn = e.target;
            const subject = clickedBtn.dataset.subject;
            
            if (subject !== CONSTANTS.SUBJECTS.RANDOM) {
                 playSound(clickAudio);
            }

            if (subject === CONSTANTS.SUBJECTS.RANDOM) {
                gameState.isRandomizing = true;
                const subjectBtns = Array.from(document.querySelectorAll('.subject-btn:not([data-subject="random"])'));
                const allSelectorBtns = document.querySelectorAll('.subject-selector .btn');
                
                allSelectorBtns.forEach(b => b.disabled = true);
                subjectBtns.forEach(b => b.classList.remove(CONSTANTS.CSS_CLASSES.SELECTED));

                randomAudio.loop = true;
                playSound(randomAudio);

                let shuffleCount = 0;
                const maxShuffles = CONSTANTS.RANDOM_ANIMATION_DURATION / CONSTANTS.RANDOM_ANIMATION_INTERVAL;

                const randomInterval = setInterval(() => {
                    shuffleCount++;
                    subjectBtns.forEach(b => b.classList.remove(CONSTANTS.CSS_CLASSES.IS_SELECTING));

                    if (shuffleCount >= maxShuffles) {
                        clearInterval(randomInterval);
                        randomAudio.pause();
                        
                        const randomIndex = Math.floor(Math.random() * subjectBtns.length);
                        const chosenBtn = subjectBtns[randomIndex];
                        
                        chosenBtn.classList.add(CONSTANTS.CSS_CLASSES.SELECTED);
                        gameState.selectedSubject = chosenBtn.dataset.subject;
                        
                        allSelectorBtns.forEach(b => b.disabled = false);
                        gameState.isRandomizing = false;
                        return;
                    }
                    
                    const currentIndex = shuffleCount % subjectBtns.length;
                    subjectBtns[currentIndex].classList.add(CONSTANTS.CSS_CLASSES.IS_SELECTING);
                }, CONSTANTS.RANDOM_ANIMATION_INTERVAL);
            } else {
                document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove(CONSTANTS.CSS_CLASSES.SELECTED));
                clickedBtn.classList.add(CONSTANTS.CSS_CLASSES.SELECTED);
                gameState.selectedSubject = subject;
            }
        });

        document.querySelector('.mode-selector').addEventListener('click', e => {
            if (!e.target.matches('.btn')) return;
            playSound(clickAudio);
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove(CONSTANTS.CSS_CLASSES.SELECTED));
            e.target.classList.add(CONSTANTS.CSS_CLASSES.SELECTED);
            gameState.gameMode = e.target.dataset.mode;
            timeSetterWrapper.style.display = gameState.gameMode === CONSTANTS.MODES.NORMAL ? 'block' : 'none';
            document.getElementById('hard-core-description').classList.toggle(CONSTANTS.CSS_CLASSES.HIDDEN, gameState.gameMode !== CONSTANTS.MODES.HARD_CORE);
        });
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const parentMain = tab.closest('main');
                if (!parentMain) return;
                parentMain.querySelectorAll('.tab').forEach(t => t.classList.remove(CONSTANTS.CSS_CLASSES.ACTIVE));
                parentMain.querySelectorAll('section').forEach(s => s.classList.remove(CONSTANTS.CSS_CLASSES.ACTIVE));
                tab.classList.add(CONSTANTS.CSS_CLASSES.ACTIVE);
                const targetSection = parentMain.querySelector(`#${tab.dataset.target}`);
                if (targetSection) targetSection.classList.add(CONSTANTS.CSS_CLASSES.ACTIVE);
            });
        });

        quizContainers.forEach(main => main.addEventListener('change', handleInputChange));
        
        startGameBtn.addEventListener('click', startGame);
        resetBtn.addEventListener('click', () => resetGame(true));
        forceQuitBtn.addEventListener('click', () => { if(gameState.timerId) { gameState.total = 0; tick(); } });
        closeModalBtn.addEventListener('click', () => stageClearModal.classList.remove(CONSTANTS.CSS_CLASSES.ACTIVE));
        
        closeGuideBtn.addEventListener('click', () => {
            guideModal.classList.remove('active');
            startModal.classList.add('active');
        });

        closeProgressModalBtn.addEventListener('click', () => {
            progressModal.classList.remove('active');
            showAnswersBtn.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
            resetBtn.classList.remove(CONSTANTS.CSS_CLASSES.HIDDEN);
        });

        decreaseTimeBtn.addEventListener('click', () => {
            playSound(clickAudio);
            if (gameState.duration > 60) {
                gameState.duration -= 60;
                updateTimeSettingDisplay();
            }
        });

        increaseTimeBtn.addEventListener('click', () => {
            playSound(clickAudio);
            if (gameState.duration < 1800) { // Max 30 mins
                gameState.duration += 60;
                updateTimeSettingDisplay();
            }
        });

        showAnswersBtn.addEventListener('click', () => {
            document.querySelectorAll(`#${gameState.selectedSubject}-quiz-main input[data-answer]`).forEach(input => {
                input.value = input.dataset.answer;
                input.disabled = true;
                if (input.classList.contains(CONSTANTS.CSS_CLASSES.CORRECT)) {
                } else {
                    input.classList.remove(CONSTANTS.CSS_CLASSES.INCORRECT, CONSTANTS.CSS_CLASSES.RETRYING);
                    input.classList.add(CONSTANTS.CSS_CLASSES.REVEALED);
                }
            });
            showAnswersBtn.disabled = true;
        });

        // --- INITIAL SETUP ---
        function initializeApp() {
            resetGame(false); // Reset state without showing any modal
            guideModal.classList.add('active'); // Always show guide on page load
        }

        initializeApp();
    });
  </script>
</body>
</html>
